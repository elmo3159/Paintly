'use client'

import { useState, useEffect } from 'react'
import { createClient } from '@/lib/supabase/client'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { ScrollArea } from '@/components/ui/scroll-area'
import { Badge } from '@/components/ui/badge'
import { Loader2, Download, Eye, Calendar, Palette } from 'lucide-react'
import Image from 'next/image'
import { ImageComparisonFixed } from '@/components/image-comparison-fixed'

interface GenerationHistoryItem {
  id: string
  created_at: string
  completed_at: string | null
  status: 'processing' | 'completed' | 'failed'
  wall_color: string | null
  roof_color: string | null
  door_color: string | null
  weather: string | null
  generated_image_url: string | null
  original_image_url: string | null
  gemini_response: { imageUrl?: string; hasImage?: boolean; originalImageUrl?: string } | null
  error_message: string | null
  prompt: string | null
}

interface GenerationHistoryProps {
  customerId: string
  refresh?: number
  autoOpenDetailId?: string | null
}

export function GenerationHistory({ customerId, refresh, autoOpenDetailId }: GenerationHistoryProps) {
  const [history, setHistory] = useState<GenerationHistoryItem[]>([])
  const [loading, setLoading] = useState(true)
  const [selectedItem, setSelectedItem] = useState<GenerationHistoryItem | null>(null)
  const supabase = createClient()

  useEffect(() => {
    fetchHistory()
  }, [customerId, refresh])

  // Auto-open detail view for latest generation
  useEffect(() => {
    if (autoOpenDetailId && history.length > 0) {
      const targetItem = history.find(item => item.id === autoOpenDetailId)
      if (targetItem) {
        console.log('ğŸ¯ Auto-opening detail view for generation:', autoOpenDetailId)
        setSelectedItem(targetItem)
      }
    }
  }, [autoOpenDetailId, history])

  const fetchHistory = async () => {
    setLoading(true)
    console.log('ğŸ” Fetching history for customer ID:', customerId)

    // Check current authenticated user with detailed debugging
    const { data: { user }, error: authError } = await supabase.auth.getUser()
    console.log('ğŸ‘¤ Current authenticated user:', { 
      user: user?.id, 
      authError,
      userEmail: user?.email,
      userExists: !!user 
    })

    if (!user) {
      console.error('âŒ No authenticated user found - RLS will block data access')
      setHistory([])
      setLoading(false)
      return
    }

    // Try the query with explicit debugging
    console.log('ğŸ”„ Attempting Supabase query with authenticated user:', user.id)
    const { data, error } = await supabase
      .from('generations')
      .select(`
        *,
        prompt,
        created_at,
        status,
        original_image_url,
        generated_image_url,
        wall_color,
        roof_color,
        door_color,
        weather,
        other_instructions
      `)
      .eq('customer_page_id', customerId)
      .order('created_at', { ascending: false })

    console.log('ğŸ“Š Supabase query result:', { 
      data, 
      error, 
      count: data?.length,
      queryParams: {
        table: 'generations',
        customer_page_id: customerId,
        user_id: user.id,
        authMethod: 'client-side-anon-key'
      }
    })

    // ğŸ”¥ NEW: Log detailed prompt data from each item
    if (data && data.length > 0) {
      console.log('ğŸ¯ DETAILED PROMPT DATA ANALYSIS:')
      data.forEach((item, index) => {
        console.log(`--- Item ${index + 1} (ID: ${item.id}) ---`)
        console.log('  hasPrompt:', !!item.prompt)
        console.log('  promptLength:', item.prompt?.length || 0)
        console.log('  promptPreview:', item.prompt?.substring(0, 50) + '...' || 'NO PROMPT')
        console.log('  allKeys:', Object.keys(item))
        console.log('  fullItem:', item)
      })
    }

    if (error) {
      console.error('âŒ History fetch error (likely RLS blocking access):', error)
      console.log('ğŸ” Error details:', {
        message: error.message,
        code: error.code,
        details: error.details,
        hint: error.hint
      })
      
      // RLS fallback: Try using public debug API when direct DB access fails
      console.log('ğŸ”„ Attempting fallback via public debug API...')
      try {
        const fallbackResponse = await fetch(`/api/public-debug?customer_id=${customerId}`)
        const fallbackData = await fallbackResponse.json()
        
        console.log('ğŸ“Š Fallback API response:', fallbackData)
        
        if (fallbackData.success && fallbackData.data?.generations) {
          console.log('âœ… Using fallback data from public API')
          setHistory(fallbackData.data.generations)
        } else {
          console.log('âš ï¸ Fallback API also returned no data')
          setHistory([])
        }
      } catch (fallbackError) {
        console.error('âŒ Fallback API also failed:', fallbackError)
        setHistory([])
      }
    } else if (!error && data) {
      console.log('âœ… Setting history data from direct Supabase query:', data)
      setHistory(data)
    } else {
      console.log('âš ï¸ No data returned from direct query, trying fallback...')
      
      // Try fallback API even when no error but no data
      try {
        const fallbackResponse = await fetch(`/api/public-debug?customer_id=${customerId}`)
        const fallbackData = await fallbackResponse.json()
        
        console.log('ğŸ“Š Fallback API response (no data case):', fallbackData)
        
        if (fallbackData.success && fallbackData.data?.generations) {
          console.log('âœ… Using fallback data (no data case)')
          setHistory(fallbackData.data.generations)
        } else {
          setHistory([])
        }
      } catch (fallbackError) {
        console.error('âŒ Fallback API failed (no data case):', fallbackError)
        setHistory([])
      }
    }
    
    setLoading(false)
  }

  const downloadImage = async (url: string, filename: string) => {
    try {
      const response = await fetch(url)
      const blob = await response.blob()
      const downloadUrl = window.URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = downloadUrl
      link.download = filename
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      window.URL.revokeObjectURL(downloadUrl)
    } catch (error) {
      console.error('Download failed:', error)
    }
  }

  // ğŸ”¥ NEW: Enhanced setSelectedItem with detailed logging
  const handleSetSelectedItem = (item: GenerationHistoryItem) => {
    console.log('ğŸ¯ SETTING SELECTED ITEM - Full Debug:')
    console.log('  itemId:', item.id)
    console.log('  hasPrompt:', !!item.prompt)
    console.log('  promptLength:', item.prompt?.length || 0)
    console.log('  promptContent:', item.prompt || 'NO PROMPT DATA')
    console.log('  itemKeys:', Object.keys(item))
    console.log('  fullSelectedItem:', item)
    setSelectedItem(item)
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <Loader2 className="h-8 w-8 animate-spin" />
      </div>
    )
  }

  if (history.length === 0) {
    return (
      <Card>
        <CardContent className="flex flex-col items-center justify-center py-12">
          <Palette className="h-12 w-12 text-muted-foreground mb-4" />
          <p className="text-muted-foreground text-center">
            ã¾ã ç”Ÿæˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“
          </p>
          <p className="text-sm text-muted-foreground text-center mt-2">
            ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆã‚¿ãƒ–ã‹ã‚‰ç”»åƒã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
          </p>
        </CardContent>
      </Card>
    )
  }

  return (
    <div className="space-y-4">
      <Card>
        <CardHeader>
          <CardTitle>ç”Ÿæˆå±¥æ­´</CardTitle>
          <CardDescription>
            éå»ã«ç”Ÿæˆã—ãŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒ
          </CardDescription>
        </CardHeader>
        <CardContent>
          <ScrollArea className="h-[600px] pr-4">
            <div className="space-y-4">
              {history.map((item) => (
                <Card key={item.id} className="overflow-hidden">
                  <CardContent className="p-4">
                    <div className="flex items-start space-x-4">
                      {/* Thumbnail */}
                      <div className="relative w-32 h-32 flex-shrink-0 bg-muted rounded-lg overflow-hidden">
                        {item.gemini_response?.imageUrl ? (
                          <Image
                            src={item.gemini_response.imageUrl}
                            alt="ç”Ÿæˆç”»åƒ"
                            fill
                            className="object-cover"
                          />
                        ) : item.status === 'processing' ? (
                          <div className="flex items-center justify-center h-full">
                            <Loader2 className="h-6 w-6 animate-spin" />
                          </div>
                        ) : (
                          <div className="flex items-center justify-center h-full">
                            <span className="text-sm text-muted-foreground">
                              ç”»åƒãªã—
                            </span>
                          </div>
                        )}
                      </div>

                      {/* Details */}
                      <div className="flex-1 space-y-2">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center space-x-2">
                            <Calendar className="h-4 w-4 text-muted-foreground" />
                            <span className="text-sm text-muted-foreground">
                              {new Date(item.created_at).toLocaleDateString('ja-JP', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                              })}
                            </span>
                          </div>
                          <Badge
                            variant={
                              item.status === 'completed' ? 'default' :
                              item.status === 'processing' ? 'secondary' :
                              'destructive'
                            }
                          >
                            {item.status === 'completed' ? 'å®Œäº†' :
                             item.status === 'processing' ? 'å‡¦ç†ä¸­' :
                             'å¤±æ•—'}
                          </Badge>
                        </div>

                        <div className="text-sm space-y-1">
                          {item.wall_color && item.wall_color !== 'å¤‰æ›´ãªã—' && (
                            <p>å£: {item.wall_color}</p>
                          )}
                          {item.roof_color && item.roof_color !== 'å¤‰æ›´ãªã—' && (
                            <p>å±‹æ ¹: {item.roof_color}</p>
                          )}
                          {item.door_color && item.door_color !== 'å¤‰æ›´ãªã—' && (
                            <p>ãƒ‰ã‚¢: {item.door_color}</p>
                          )}
                          {item.weather && (
                            <p>å¤©å€™: {item.weather}</p>
                          )}
                        </div>

                        {item.error_message && (
                          <p className="text-sm text-destructive">
                            ã‚¨ãƒ©ãƒ¼: {item.error_message}
                          </p>
                        )}

                        {item.status === 'completed' && item.gemini_response?.imageUrl && (
                          <div className="flex space-x-2 pt-2">
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => handleSetSelectedItem(item)}
                            >
                              <Eye className="h-4 w-4 mr-1" />
                              è©³ç´°
                            </Button>
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => downloadImage(
                                item.gemini_response?.imageUrl || '',
                                `paintly_${item.id}.png`
                              )}
                            >
                              <Download className="h-4 w-4 mr-1" />
                              ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </Button>
                          </div>
                        )}
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          </ScrollArea>
        </CardContent>
      </Card>

      {/* Detail Modal - To be implemented with a proper modal component */}
      {selectedItem && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
          <Card className="max-w-4xl w-full max-h-[90vh] overflow-auto">
            <CardHeader>
              <CardTitle>ç”Ÿæˆç”»åƒè©³ç´°</CardTitle>
              <Button
                className="absolute top-4 right-4"
                variant="ghost"
                size="sm"
                onClick={() => setSelectedItem(null)}
              >
                âœ•
              </Button>
            </CardHeader>
            <CardContent className="space-y-4">
              {(() => {
                // æœ‰åŠ¹ãªç”»åƒURLã‚’å–å¾—ï¼ˆplaceholderæ–‡å­—åˆ—ã‚’é™¤å¤–ï¼‰
                const validOriginalUrl = selectedItem.original_image_url &&
                  selectedItem.original_image_url !== 'placeholder' &&
                  selectedItem.original_image_url.startsWith('http') ?
                  selectedItem.original_image_url :
                  selectedItem.gemini_response?.originalImageUrl;

                const validGeneratedUrl = selectedItem.generated_image_url ||
                  selectedItem.gemini_response?.imageUrl;

                console.log('ğŸ” ImageComparison Debug - Raw URLs:');
                console.log('  ğŸ“ rawOriginalUrl:', selectedItem.original_image_url);
                console.log('  ğŸ“ rawGeneratedUrl:', selectedItem.generated_image_url);
                console.log('  ğŸ¤– geminiImageUrl:', selectedItem.gemini_response?.imageUrl);
                console.log('  ğŸ¤– geminiOriginalUrl:', selectedItem.gemini_response?.originalImageUrl);
                console.log('ğŸ¯ Final Valid URLs:');
                console.log('  âœ… validOriginalUrl:', validOriginalUrl);
                console.log('  âœ… validGeneratedUrl:', validGeneratedUrl);
                console.log('  ğŸ® willShowComparison:', !!(validGeneratedUrl && validOriginalUrl));
                return null;
              })()}
              {(() => {
                // ãƒ‡ãƒãƒƒã‚°éƒ¨åˆ†ã§å®šç¾©ã—ãŸå€¤ã‚’å†åˆ©ç”¨
                const validOriginalUrl = selectedItem.original_image_url &&
                  selectedItem.original_image_url !== 'placeholder' &&
                  selectedItem.original_image_url.startsWith('http') ?
                  selectedItem.original_image_url :
                  selectedItem.gemini_response?.originalImageUrl;

                const validGeneratedUrl = selectedItem.generated_image_url ||
                  selectedItem.gemini_response?.imageUrl;

                if (validGeneratedUrl && validOriginalUrl) {
                  return (
                    <ImageComparisonFixed
                      originalImage={validOriginalUrl}
                      generatedImage={validGeneratedUrl}
                      title="ãƒ“ãƒ•ã‚©ãƒ¼ã‚¢ãƒ•ã‚¿ãƒ¼æ¯”è¼ƒ"
                      allowDownload={true}
                    />
                  );
                } else if (validGeneratedUrl) {
                  return (
                    <div className="relative aspect-video w-full overflow-hidden rounded-lg bg-muted">
                      <Image
                        src={validGeneratedUrl}
                        alt="ç”Ÿæˆç”»åƒ"
                        fill
                        className="object-contain"
                      />
                    </div>
                  );
                } else {
                  return (
                    <div className="text-center p-8 text-muted-foreground">
                      <p>ç”»åƒã®èª­ã¿è¾¼ã¿ã«å•é¡ŒãŒã‚ã‚Šã¾ã™</p>
                    </div>
                  );
                }
              })()}
              <div className="space-y-2">
                <p className="text-sm">
                  <strong>ç”Ÿæˆæ—¥æ™‚:</strong> {new Date(selectedItem.created_at).toLocaleString('ja-JP')}
                </p>
                <p className="text-sm">
                  <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> {selectedItem.status === 'completed' ? 'å®Œäº†' : selectedItem.status}
                </p>
                <div className="text-sm">
                  <strong>è¨­å®šå†…å®¹:</strong>
                  <div className="mt-2 p-2 bg-muted rounded text-xs space-y-1">
                    {selectedItem.wall_color && selectedItem.wall_color !== 'å¤‰æ›´ãªã—' && (
                      <div>å£ã®è‰²: {selectedItem.wall_color}</div>
                    )}
                    {selectedItem.roof_color && selectedItem.roof_color !== 'å¤‰æ›´ãªã—' && (
                      <div>å±‹æ ¹ã®è‰²: {selectedItem.roof_color}</div>
                    )}
                    {selectedItem.door_color && selectedItem.door_color !== 'å¤‰æ›´ãªã—' && (
                      <div>ãƒ‰ã‚¢ã®è‰²: {selectedItem.door_color}</div>
                    )}
                    {selectedItem.weather && (
                      <div>å¤©å€™: {selectedItem.weather}</div>
                    )}
                  </div>
                </div>

                {/* Enhanced Debug: Show generated prompt with forced logging */}
                {(() => {
                  console.log('ğŸ¯ FINAL Prompt Debug (in Modal):', {
                    hasPrompt: !!selectedItem.prompt,
                    promptLength: selectedItem.prompt?.length || 0,
                    promptPreview: selectedItem.prompt?.substring(0, 100) || 'No prompt',
                    fullSelectedItem: selectedItem,
                    itemKeys: Object.keys(selectedItem),
                    promptValue: selectedItem.prompt
                  });
                  return null;
                })()}
                {selectedItem.prompt ? (
                  <div className="text-sm">
                    <strong>ğŸ” ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ:</strong>
                    <div className="mt-2 p-3 bg-slate-100 border rounded text-xs font-mono max-h-40 overflow-y-auto">
                      <pre className="whitespace-pre-wrap break-words">
                        {selectedItem.prompt}
                      </pre>
                    </div>
                    <p className="text-xs text-muted-foreground mt-1">
                      â€» ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šAIç”Ÿæˆã«ä½¿ç”¨ã•ã‚ŒãŸå®Ÿéš›ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹
                    </p>
                  </div>
                ) : (
                  <div className="text-sm">
                    <strong>âš ï¸ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæƒ…å ±ãªã—:</strong>
                    <p className="text-xs text-muted-foreground mt-1">
                      ã“ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã¯ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ‡ãƒ¼ã‚¿ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“
                    </p>
                    <div className="mt-2 p-2 bg-red-50 border border-red-200 rounded text-xs">
                      <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong>
                      <ul className="mt-1 space-y-1">
                        <li>â€¢ selectedItem.prompt: {String(selectedItem.prompt)}</li>
                        <li>â€¢ typeof prompt: {typeof selectedItem.prompt}</li>
                        <li>â€¢ Object keys: {Object.keys(selectedItem).join(', ')}</li>
                      </ul>
                    </div>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  )
}