# ğŸ“ Paintly é‡è¦ãªå­¦ç¿’äº‹é …ãƒ»é–‹ç™ºä¸Šã®æ³¨æ„ç‚¹

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Paintlyé–‹ç™ºã§é­é‡ã—ãŸé‡è¦ãªå­¦ç¿’äº‹é …ã¨æ³¨æ„ç‚¹ã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

---

## Next.js 15 ç ´å£Šçš„å¤‰æ›´ï¼ˆ2025å¹´10æœˆæ™‚ç‚¹ï¼‰

### å‹•çš„ãƒ«ãƒ¼ãƒˆã®paramsãŒPromiseå‹ã«å¤‰æ›´

Next.js 15ã§ã¯ã€å‹•çš„ãƒ«ãƒ¼ãƒˆã® `params` ãŒ Promiseå‹ã«å¤‰æ›´ã•ã‚Œã¾ã—ãŸã€‚æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’æ›´æ–°ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

**æ—§å®Ÿè£…ï¼ˆNext.js 14ä»¥å‰ï¼‰:**
```typescript
export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const shareId = params.id
  // ...
}
```

**æ–°å®Ÿè£…ï¼ˆNext.js 15ï¼‰:**
```typescript
export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  const { id: shareId } = await params  // awaitãŒå¿…é ˆ
  // ...
}
```

**å½±éŸ¿ç¯„å›²:**
- `app/api/[dynamic]/route.ts` - API Routes
- `app/[dynamic]/page.tsx` - Page Routes
- ã™ã¹ã¦ã®å‹•çš„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãƒ«ãƒ¼ãƒˆ

**ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ä¾‹:**
```
Type error: Type '{ __tag__: "GET"; __param_position__: "second"; __param_type__: { params: { id: string; }; }; }' does not satisfy the constraint 'ParamCheck<RouteContext>'.
  The types of '__param_type__.params' are incompatible between these types.
    Type '{ id: string; }' is missing the following properties from type 'Promise<any>': then, catch, finally, [Symbol.toStringTag]
```

---

## Supabaseæ¨©é™ãƒ¢ãƒ‡ãƒ«ã¨Storageã‚¢ã‚¯ã‚»ã‚¹

### anonã‚­ãƒ¼ vs service_roleã‚­ãƒ¼ã®ä½¿ã„åˆ†ã‘

#### anonã‚­ãƒ¼ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ç”¨ï¼‰
- âœ… ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ä½¿ç”¨å¯èƒ½
- âœ… RLSï¼ˆRow Level Securityï¼‰ãƒãƒªã‚·ãƒ¼ã«å¾“ã†
- âŒ ç½²åä»˜ãURLã¯ç”Ÿæˆã§ããªã„
- âŒ RLSã‚’ãƒã‚¤ãƒ‘ã‚¹ã§ããªã„

#### service_roleã‚­ãƒ¼ï¼ˆã‚µãƒ¼ãƒãƒ¼å´å°‚ç”¨ï¼‰
- âŒ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯çµ¶å¯¾ã«ä½¿ç”¨ã—ãªã„ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ï¼‰
- âœ… ã‚µãƒ¼ãƒãƒ¼å´API Routesã§ã®ã¿ä½¿ç”¨
- âœ… ç½²åä»˜ãURLã‚’ç”Ÿæˆå¯èƒ½
- âœ… RLSã‚’ãƒã‚¤ãƒ‘ã‚¹ã§ãã‚‹
- âœ… ç®¡ç†è€…æ¨©é™ã§ã®æ“ä½œãŒå¯èƒ½

### ç½²åä»˜ãURLç”Ÿæˆã®æ­£ã—ã„å®Ÿè£…

**âŒ é–“é•ã„: anonã‚­ãƒ¼ã§ã¯ç½²åä»˜ãURLã‚’ç”Ÿæˆã§ããªã„**
```typescript
import { createClient } from '@/lib/supabase/server'
const supabase = await createClient()  // ã“ã‚Œã¯anonã‚­ãƒ¼ã‚’ä½¿ç”¨
```

**âœ… æ­£è§£: service_roleã‚­ãƒ¼ã§ç½²åä»˜ãURLã‚’ç”Ÿæˆ**
```typescript
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!

const supabase = createClient(supabaseUrl, supabaseServiceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})

// ç½²åä»˜ãURLç”Ÿæˆï¼ˆ7æ—¥é–“æœ‰åŠ¹ï¼‰
const { data, error } = await supabase.storage
  .from('bucket-name')
  .createSignedUrl('file-path', 60 * 60 * 24 * 7)
```

### ç½²åä»˜ãURLã®ãƒ¡ãƒªãƒƒãƒˆ
- æ™‚é–“åˆ¶é™ä»˜ãã‚¢ã‚¯ã‚»ã‚¹ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šï¼‰
- èªè¨¼ä¸è¦ã§ç”»åƒã‚’å…±æœ‰å¯èƒ½
- ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¤±åŠ¹ã™ã‚Œã°è‡ªå‹•çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
- ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒã‚±ãƒƒãƒˆã®ç”»åƒã‚’å®‰å…¨ã«å…±æœ‰

---

## Service Workerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œ

### é–‹ç™ºä¸­ã®æ³¨æ„äº‹é …

**ç—‡çŠ¶:**
- curlã‚„Postmanã§APIãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã®ã«ã€ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯å¤±æ•—
- `net::ERR_FAILED` ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
- å¤ã„ã‚³ãƒ¼ãƒ‰ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã¦æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ãŒåæ˜ ã•ã‚Œãªã„

**åŸå› :**
Service WorkerãŒå¤ã„ã‚³ãƒ¼ãƒ‰ã‚„ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã„ã‚‹

**è§£æ±ºæ–¹æ³•:**
```javascript
// ãƒ–ãƒ©ã‚¦ã‚¶ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§å®Ÿè¡Œ
const registrations = await navigator.serviceWorker.getRegistrations();
for (const reg of registrations) {
  await reg.unregister();
}

// ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
location.reload();
```

### é–‹ç™ºæ™‚ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
1. Chrome DevToolsã§ã€ŒDisable cacheã€ã‚’ã‚ªãƒ³ã«ã™ã‚‹
2. Application ã‚¿ãƒ–ã§ Service Worker ã‚’ç¢ºèªãƒ»å‰Šé™¤
3. æœ¬ç•ªç’°å¢ƒã§ã¯æ…é‡ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’è¨­è¨ˆ
4. Service Workerã®ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æ©Ÿèƒ½ã‚’æ´»ç”¨

---

## ãƒ‡ãƒãƒƒã‚°ã®åŠ¹ç‡çš„ãªé †åº

### APIã‚¨ãƒ©ãƒ¼ã®ãƒ‡ãƒãƒƒã‚°æ‰‹é †

#### 1. ã‚µãƒ¼ãƒãƒ¼å´ã®æ¤œè¨¼ï¼ˆcurlã‚„Postmanã‚’ä½¿ç”¨ï¼‰
```bash
curl -s "https://your-app.vercel.app/api/endpoint"
```
â†’ ã“ã‚Œã§æ­£å¸¸ã«å‹•ä½œã™ã‚Œã°ã€ã‚µãƒ¼ãƒãƒ¼å´ã¯å•é¡Œãªã—

#### 2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®æ¤œè¨¼ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰
- Network ã‚¿ãƒ–ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç¢ºèª
- Console ã‚¿ãƒ–ã§ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
- Application ã‚¿ãƒ–ã§ Service Worker ã‚’ç¢ºèª

#### 3. å•é¡Œã®åˆ‡ã‚Šåˆ†ã‘
- **ã‚µãƒ¼ãƒãƒ¼å´ã§å¤±æ•—** â†’ APIã‚³ãƒ¼ãƒ‰ã®å•é¡Œ
- **ã‚µãƒ¼ãƒãƒ¼å´ã§æˆåŠŸã€ãƒ–ãƒ©ã‚¦ã‚¶ã§å¤±æ•—** â†’ Service Worker/CORS/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å•é¡Œ

### ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³

**curlã§æˆåŠŸã€ãƒ–ãƒ©ã‚¦ã‚¶ã§å¤±æ•—:**
- Service Workerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- CORSã®è¨­å®šãƒŸã‚¹
- ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- Cookie/èªè¨¼ã®å•é¡Œ

**ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚‚curlã§ã‚‚å¤±æ•—:**
- APIã‚³ãƒ¼ãƒ‰ã®ãƒã‚°
- ç’°å¢ƒå¤‰æ•°ã®è¨­å®šãƒŸã‚¹
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼
- å¤–éƒ¨APIï¼ˆSupabaseç­‰ï¼‰ã®å•é¡Œ

---

## Vercelãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã®ç¢ºèªæ–¹æ³•

```bash
# ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œï¼ˆVercelã¨åŒã˜ç’°å¢ƒã§ç¢ºèªï¼‰
npm run build

# Vercelã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’ç¢ºèª
npx vercel ls your-project --token YOUR_TOKEN

# ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
npx vercel env ls --token YOUR_TOKEN
```

### ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
```bash
# Vercelã«ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ 
npx vercel env add VARIABLE_NAME --token YOUR_TOKEN

# æœ¬ç•ªç’°å¢ƒã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã€é–‹ç™ºç’°å¢ƒã™ã¹ã¦ã«è¨­å®š
# Production, Preview, Development ã‚’é¸æŠ
```

### é‡è¦ãªç’°å¢ƒå¤‰æ•°
- **`SUPABASE_SERVICE_ROLE_KEY`**: ã‚µãƒ¼ãƒãƒ¼å´ã§ã®ã¿ä½¿ç”¨ã€çµ¶å¯¾ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«éœ²å‡ºã•ã›ãªã„
- **`NEXT_PUBLIC_*`**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ä½¿ç”¨å¯èƒ½ãªç’°å¢ƒå¤‰æ•°ï¼ˆå…¬é–‹ã•ã‚Œã‚‹ã®ã§æ©Ÿå¯†æƒ…å ±ã¯å«ã‚ãªã„ï¼‰

---

## QRã‚³ãƒ¼ãƒ‰å…±æœ‰æ©Ÿèƒ½ã®å®Ÿè£…ãƒã‚¤ãƒ³ãƒˆ

### ç½²åä»˜ãURLç”Ÿæˆãƒ•ãƒ­ãƒ¼
```
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå…±æœ‰ãƒªãƒ³ã‚¯ã«ã‚¢ã‚¯ã‚»ã‚¹
   â†“
2. /api/share/[id] ãŒå‘¼ã°ã‚Œã‚‹
   â†“
3. service_role keyã§Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ
   â†“
4. shared_imagesãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ç”»åƒæƒ…å ±ã‚’å–å¾—
   â†“
5. å„ç”»åƒURLã‹ã‚‰ç½²åä»˜ãURLã‚’ç”Ÿæˆï¼ˆ7æ—¥é–“æœ‰åŠ¹ï¼‰
   â†“
6. ç½²åä»˜ãURLã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™
   â†“
7. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ç”»åƒã‚’è¡¨ç¤ºãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
```

### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- æœ‰åŠ¹æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯ï¼ˆ410 Goneï¼‰
- å…±æœ‰ãƒªãƒ³ã‚¯ãŒå­˜åœ¨ã—ãªã„ãƒã‚§ãƒƒã‚¯ï¼ˆ404 Not Foundï¼‰
- ã‚¢ã‚¯ã‚»ã‚¹ã‚«ã‚¦ãƒ³ãƒˆã®æ›´æ–°ï¼ˆæ¥½è¦³çš„æ›´æ–°ï¼‰
- ç½²åä»˜ãURLç”Ÿæˆå¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå…ƒã®URLã‚’ä½¿ç”¨ï¼‰

---

## ä»Šå¾Œã®é–‹ç™ºã§æ³¨æ„ã™ã¹ãã“ã¨

### 1. Next.js 15ã®å‹å¤‰æ›´ã¯ä»–ã®ãƒ«ãƒ¼ãƒˆã«ã‚‚é©ç”¨å¿…è¦
- ã™ã¹ã¦ã®å‹•çš„ãƒ«ãƒ¼ãƒˆã§ `params` ã‚’ `await` ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- API Routesã€Page Routesä¸¡æ–¹ã§å¯¾å¿œãŒå¿…è¦

### 2. Supabaseã®ã‚­ãƒ¼ç®¡ç†ã‚’å¾¹åº•
- service_roleã‚­ãƒ¼ã¯çµ¶å¯¾ã«ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã«éœ²å‡ºã•ã›ãªã„
- ç’°å¢ƒå¤‰æ•°ã¯ `.env.local` ã¨ Vercel ã®ä¸¡æ–¹ã«è¨­å®š
- GitHubç­‰ã«ç’°å¢ƒå¤‰æ•°ã‚’ã‚³ãƒŸãƒƒãƒˆã—ãªã„ï¼ˆ.gitignoreã§ä¿è­·ï¼‰

### 3. Service Workerã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’æ…é‡ã«è¨­è¨ˆ
- é–‹ç™ºä¸­ã¯ç„¡åŠ¹åŒ–ã‚‚æ¤œè¨
- æœ¬ç•ªç’°å¢ƒã§ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æ©Ÿèƒ½ã‚’æ´»ç”¨
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ã‚’é©åˆ‡ã«è¨­å®š

### 4. ç½²åä»˜ãURLã®æœ‰åŠ¹æœŸé™ã‚’é©åˆ‡ã«è¨­å®š
- ç¾åœ¨ã¯7æ—¥é–“ã ãŒã€ç”¨é€”ã«å¿œã˜ã¦èª¿æ•´å¯èƒ½
- çŸ­ã™ãã‚‹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãŒæ‚ªåŒ–ã€é•·ã™ãã‚‹ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯
- å…±æœ‰æ©Ÿèƒ½ã®ç”¨é€”ã«åˆã‚ã›ã¦è¨­è¨ˆ

---

## QRã‚³ãƒ¼ãƒ‰å…±æœ‰URLç”Ÿæˆã®å•é¡Œ

### å•é¡Œã®è©³ç´°
QRã‚³ãƒ¼ãƒ‰å…±æœ‰æ©Ÿèƒ½ã§ç”Ÿæˆã•ã‚Œã‚‹URLãŒã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆ`paintly-elmos-projects-cf77d205.vercel.app`ï¼‰ã«ãªã£ã¦ã—ã¾ã„ã€æœ¬ç•ªç’°å¢ƒã®ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆ`paintly-chi.vercel.app`ï¼‰ã«ãªã‚‰ãªã„å•é¡ŒãŒç™ºç”Ÿã€‚

### åŸå› 
`app/api/share/create/route.ts` ã®111è¡Œç›®ã§ã€ç’°å¢ƒå¤‰æ•° `NEXT_PUBLIC_APP_URL` ãŒæœªè¨­å®šã®å ´åˆã€`request.nextUrl.origin` ã‚’ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦ä½¿ç”¨ã—ã¦ã„ãŸï¼š

```typescript
const baseUrl = process.env.NEXT_PUBLIC_APP_URL || request.nextUrl.origin
```

`.env.local` ã§ã¯ `NEXT_PUBLIC_APP_URL=http://localhost:3005` ã¨ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ã®å€¤ãŒè¨­å®šã•ã‚Œã¦ãŠã‚Šã€æœ¬ç•ªç’°å¢ƒURLãŒè¨­å®šã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚

### è§£æ±ºç­–
1. **.env.local ã®æ›´æ–°**:
   ```
   NEXT_PUBLIC_APP_URL=https://paintly-chi.vercel.app
   ```

2. **Vercelç’°å¢ƒå¤‰æ•°ã®æ›´æ–°** (Vercel APIçµŒç”±):
   ```bash
   curl -X PATCH "https://api.vercel.com/v10/projects/{projectId}/env/{envId}" \
     -H "Authorization: Bearer {token}" \
     -d '{"value":"https://paintly-chi.vercel.app","target":["production","preview","development"]}'
   ```

3. **å†ãƒ‡ãƒ—ãƒ­ã‚¤**: ç’°å¢ƒå¤‰æ•°ã®å¤‰æ›´ã‚’åæ˜ ã•ã›ã‚‹ãŸã‚ã€ã‚³ãƒ¼ãƒ‰ã®å°ã•ãªå¤‰æ›´ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦å†ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ãƒˆãƒªã‚¬ãƒ¼

### å­¦ã‚“ã ã“ã¨
- `NEXT_PUBLIC_*` ç’°å¢ƒå¤‰æ•°ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ãŸã‚ã€å¤‰æ›´å¾Œã¯å†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…é ˆ
- `request.nextUrl.origin` ã¯å‹•çš„ãªå€¤ã§ã‚ã‚Šã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã‚„ãƒ–ãƒ©ãƒ³ãƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã§ã¯ç•°ãªã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’è¿”ã™
- æœ¬ç•ªç’°å¢ƒURLã¯å¿…ãšæ˜ç¤ºçš„ã«ç’°å¢ƒå¤‰æ•°ã§è¨­å®šã™ã¹ã
- Vercelç’°å¢ƒå¤‰æ•°ã®æ›´æ–°ã«ã¯ Vercel API (`PATCH /v10/projects/{projectId}/env/{envId}`) ã‚’ä½¿ç”¨å¯èƒ½

### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
- `app/api/share/create/route.ts` (line 111-112)
- `.env.local`
- Vercelç’°å¢ƒå¤‰æ•°è¨­å®š

---

## QRã‚³ãƒ¼ãƒ‰å…±æœ‰æ©Ÿèƒ½ã®æ¤œè¨¼ã¨Service Workerã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œï¼ˆ2å›ç›®ï¼‰

### å•é¡Œã®å†ç™ºè¦‹ï¼ˆ2025å¹´10æœˆ14æ—¥ï¼‰

ç’°å¢ƒå¤‰æ•°ã‚’ä¿®æ­£ã—ã¦å†ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’ãƒ†ã‚¹ãƒˆã—ãŸã¨ã“ã‚ã€ä»¥ä¸‹ã®ç—‡çŠ¶ãŒå†ç™ºï¼š

**ç—‡çŠ¶:**
- æ–°ã—ãç”Ÿæˆã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰å…±æœ‰URLã¯æ­£ã—ã„æœ¬ç•ªãƒ‰ãƒ¡ã‚¤ãƒ³ï¼ˆ`paintly-chi.vercel.app`ï¼‰ã‚’ä½¿ç”¨
- ã—ã‹ã—ã€ãã®URLã«ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ŒäºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€ãŒè¡¨ç¤º
- curlã§åŒã˜APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨æ­£å¸¸ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹
- ãƒ–ãƒ©ã‚¦ã‚¶ã®Network ã‚¿ãƒ–ã§ `net::ERR_FAILED` ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ

### æ ¹æœ¬åŸå› ã®ç‰¹å®š

**Service WorkerãŒå¤ã„ã‚³ãƒ¼ãƒ‰ã‚’å†åº¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ã„ãŸ**

ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒãƒšãƒ¼ã‚¸ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨æ–°ã—ã„Service WorkerãŒç™»éŒ²ã•ã‚Œã‚‹ã€‚ã—ã‹ã—ï¼š
1. å¤ã„Service WorkerãŒã¾ã ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆãŒã‚ã‚‹
2. æ–°ã—ã„SWãŒç™»éŒ²ã•ã‚Œã¦ã‚‚ã€å¤ã„SWã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ®‹ã£ã¦ã„ã‚‹
3. PWAæ©Ÿèƒ½ã«ã‚ˆã‚Šã€APIãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‚ç…§ã—ã¦ã—ã¾ã†

### æ¤œè¨¼ãƒ—ãƒ­ã‚»ã‚¹

**1. curlã§ã®APIæ¤œè¨¼ï¼ˆæˆåŠŸï¼‰**
```bash
curl -s "https://paintly-chi.vercel.app/api/share/5fe2f54d-3090-4e16-ad2c-48e265c00899"
# â†’ æ­£å¸¸ã«JSON ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã‚‹ï¼ˆç½²åä»˜ãURLå«ã‚€ï¼‰
```

**2. ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆå¤±æ•—ï¼‰**
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ã€ŒäºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€
- Console ã‚¨ãƒ©ãƒ¼: `net::ERR_FAILED`

**3. Service Workerå‰Šé™¤ï¼ˆè§£æ±ºï¼‰**
```javascript
const registrations = await navigator.serviceWorker.getRegistrations();
for (const reg of registrations) {
  await reg.unregister();
}
location.reload();
```

**4. å†ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆæˆåŠŸï¼‰**
- å…±æœ‰ãƒšãƒ¼ã‚¸ãŒæ­£å¸¸ã«è¡¨ç¤º
- ç”»åƒ2æšãŒè¡¨ç¤ºã•ã‚Œã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚‚æ­£å¸¸å‹•ä½œ
- ã‚¢ã‚¯ã‚»ã‚¹ã‚«ã‚¦ãƒ³ãƒˆãŒæ­£å¸¸ã«è¨˜éŒ²

### é‡è¦ãªå­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ

#### 1. Service Workerã®äºŒæ®µéšå•é¡Œ

**ç¬¬ä¸€æ®µéš**: é–‹ç™ºä¸­ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºä¸­ã«å¤ã„ã‚³ãƒ¼ãƒ‰ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹
- â†’ é–‹ç™ºæ™‚ã¯ã€ŒDisable cacheã€ã‚’æœ‰åŠ¹ã«ã™ã‚‹

**ç¬¬äºŒæ®µéš**: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆä»Šå›é­é‡ï¼‰
- æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚‚ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ–ãƒ©ã‚¦ã‚¶ã«å¤ã„SWãŒæ®‹ã‚‹
- â†’ ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥ãŒå¿…è¦

#### 2. ãƒ‡ãƒãƒƒã‚°ã®åŠ¹ç‡çš„ãªé †åºï¼ˆå†ç¢ºèªï¼‰

**å¿…ãšã“ã®é †åºã§æ¤œè¨¼ã™ã‚‹:**
```
1. curl/Postmanã§ã‚µãƒ¼ãƒãƒ¼å´ã‚’æ¤œè¨¼
   â†“
2. ã‚µãƒ¼ãƒãƒ¼ãŒæ­£å¸¸ â†’ ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒ†ã‚¹ãƒˆ
   â†“
3. ãƒ–ãƒ©ã‚¦ã‚¶ã§å¤±æ•— â†’ Service Worker/ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ç–‘ã†
   â†“
4. Service Workerå‰Šé™¤ â†’ å†ãƒ†ã‚¹ãƒˆ
```

**curlã§æˆåŠŸã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã§å¤±æ•— = ã»ã¼100% ã‚­ãƒ£ãƒƒã‚·ãƒ¥å•é¡Œ**

#### 3. Next.js PWAã¨Service Workerã®ç®¡ç†

**ç¾åœ¨ã®å•é¡Œç‚¹:**
- `public/sw.js` ã§Service Workerã‚’ç™»éŒ²ã—ã¦ã„ã‚‹
- ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æ©Ÿèƒ½ãŒãªã„
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ãŒæ˜ç¤ºçš„ã§ãªã„

**æ”¹å–„ã™ã¹ãç‚¹:**
```javascript
// sw.js ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’è¿½åŠ 
const CACHE_VERSION = 'v1.0.0';
const CACHE_NAME = `paintly-cache-${CACHE_VERSION}`;

// å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
self.addEventListener('activate', (event) => {
  event.waitUntil(
    caches.keys().then((cacheNames) => {
      return Promise.all(
        cacheNames
          .filter((name) => name !== CACHE_NAME)
          .map((name) => caches.delete(name))
      );
    })
  );
});
```

#### 4. ç’°å¢ƒå¤‰æ•°ã®è¨­å®šãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼ˆå†ç¢ºèªï¼‰

**`NEXT_PUBLIC_*` ç’°å¢ƒå¤‰æ•°ã®ç‰¹æ€§ã‚’ç†è§£ã™ã‚‹:**

- âœ… ãƒ“ãƒ«ãƒ‰æ™‚ã«åŸ‹ã‚è¾¼ã¾ã‚Œã‚‹ï¼ˆé™çš„ï¼‰
- âœ… ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§èª­ã¿å–ã‚Šå¯èƒ½
- âŒ ãƒ“ãƒ«ãƒ‰å¾Œã¯å¤‰æ›´ä¸å¯ï¼ˆå†ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¿…é ˆï¼‰
- âŒ å‹•çš„ãªå€¤ã«ä¾å­˜ã—ã¦ã¯ã„ã‘ãªã„

**è‰¯ã„ä¾‹:**
```typescript
// æ˜ç¤ºçš„ã«æœ¬ç•ªURLã‚’è¨­å®š
const baseUrl = process.env.NEXT_PUBLIC_APP_URL; // 'https://paintly-chi.vercel.app'
if (!baseUrl) throw new Error('NEXT_PUBLIC_APP_URL is required');
```

**æ‚ªã„ä¾‹:**
```typescript
// å‹•çš„ãªå€¤ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆç’°å¢ƒã«ã‚ˆã£ã¦ç•°ãªã‚‹å€¤ã«ãªã‚‹ï¼‰
const baseUrl = process.env.NEXT_PUBLIC_APP_URL || request.nextUrl.origin;
```

#### 5. Vercelç’°å¢ƒå¤‰æ•°ã®æ›´æ–°æ–¹æ³•

**Vercel APIçµŒç”±ã§ã®æ›´æ–°ï¼ˆæ¨å¥¨ï¼‰:**
```bash
# 1. ç’°å¢ƒå¤‰æ•°IDã‚’å–å¾—
curl "https://api.vercel.com/v9/projects/{projectId}/env" \
  -H "Authorization: Bearer {token}" | jq

# 2. ç’°å¢ƒå¤‰æ•°ã‚’æ›´æ–°
curl -X PATCH "https://api.vercel.com/v10/projects/{projectId}/env/{envId}" \
  -H "Authorization: Bearer {token}" \
  -H "Content-Type: application/json" \
  -d '{"value":"https://paintly-chi.vercel.app","target":["production","preview","development"]}'

# 3. å†ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆç’°å¢ƒå¤‰æ•°å¤‰æ›´ã‚’åæ˜ ï¼‰
git commit --allow-empty -m "chore: trigger redeploy for env var update"
git push
```

**Vercel DashboardçµŒç”±ã§ã®æ›´æ–°:**
1. Project Settings â†’ Environment Variables
2. å¤‰æ›´ã—ãŸã„å¤‰æ•°ã®ã€ŒEditã€ã‚’ã‚¯ãƒªãƒƒã‚¯
3. å€¤ã‚’æ›´æ–°ã—ã¦ä¿å­˜
4. ã€ŒRedeployã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

### æ¤œè¨¼æˆåŠŸã®è¨˜éŒ²

**ç”Ÿæˆã•ã‚ŒãŸQRã‚³ãƒ¼ãƒ‰å…±æœ‰URL:**
`https://paintly-chi.vercel.app/share/5fe2f54d-3090-4e16-ad2c-48e265c00899`

**æ¤œè¨¼çµæœï¼ˆã™ã¹ã¦âœ…ï¼‰:**
- âœ… æ­£ã—ã„æœ¬ç•ªãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ç”¨
- âœ… å…±æœ‰ãƒšãƒ¼ã‚¸ãŒæ­£å¸¸ã«è¡¨ç¤º
- âœ… ã‚¿ã‚¤ãƒˆãƒ«: ã€Œå¡—è£…ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”»åƒã€
- âœ… ä½œæˆæ—¥: 2025/10/14
- âœ… é–²è¦§æ•°: 3å›ï¼ˆã‚¢ã‚¯ã‚»ã‚¹ã‚«ã‚¦ãƒ³ãƒˆæ©Ÿèƒ½ãŒæ­£å¸¸å‹•ä½œï¼‰
- âœ… æœ‰åŠ¹æœŸé™: 2025/10/21ã¾ã§æœ‰åŠ¹
- âœ… ç”»åƒ2æšãŒæ­£å¸¸ã«è¡¨ç¤º
- âœ… å€‹åˆ¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½
- âœ… ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ãŒæ©Ÿèƒ½

### ä»Šå¾Œã®å¯¾ç­–

**çŸ­æœŸçš„å¯¾ç­–ï¼ˆé–‹ç™ºä¸­ï¼‰:**
1. Chrome DevToolsã§ã€ŒDisable cacheã€ã‚’å¸¸æ™‚ã‚ªãƒ³
2. Application ã‚¿ãƒ–ã§Service Workerã‚’å®šæœŸçš„ã«ç¢ºèªãƒ»å‰Šé™¤
3. ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã¯å¿…ãšService Workerã‚’ã‚¯ãƒªã‚¢ã—ã¦ãƒ†ã‚¹ãƒˆ

**é•·æœŸçš„å¯¾ç­–ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰:**
1. Service Workerã«ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æ©Ÿèƒ½ã‚’å®Ÿè£…
2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥ã‚’æ˜ç¤ºçš„ã«å®šç¾©
3. å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’è‡ªå‹•å‰Šé™¤ã™ã‚‹ä»•çµ„ã¿ã‚’è¿½åŠ 
4. PWAæ›´æ–°æ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥æ©Ÿèƒ½ã‚’å®Ÿè£…

**ç’°å¢ƒå¤‰æ•°ç®¡ç†:**
1. `.env.local` ã¨ Vercelç’°å¢ƒå¤‰æ•°ã‚’å¿…ãšåŒæœŸ
2. `NEXT_PUBLIC_*` å¤‰æ•°ã¯çµ¶å¯¾ã«å‹•çš„å€¤ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ãªã„
3. ç’°å¢ƒå¤‰æ•°å¤‰æ›´å¾Œã¯å¿…ãšå†ãƒ‡ãƒ—ãƒ­ã‚¤
4. Vercel APIã‚’ä½¿ã£ãŸè‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ¤œè¨

---

## å‚è€ƒè³‡æ–™

- [Next.js 15 Migration Guide](https://nextjs.org/docs/app/building-your-application/upgrading/version-15)
- [Supabase Storage Signed URLs](https://supabase.com/docs/guides/storage/signed-urls)
- [Service Worker API](https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API)
- [Vercel Environment Variables](https://vercel.com/docs/projects/environment-variables)
- [Vercel API - Environment Variables](https://vercel.com/docs/rest-api/endpoints/environment-variables)

---

**æœ€çµ‚æ›´æ–°æ—¥**: 2025å¹´10æœˆ14æ—¥
